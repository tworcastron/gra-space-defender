<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gra: Space defender</title>

  <style>
    html { font-family: 'consolas'; }
    h1 { text-align: center; }
    #game-board {
      width: 600px;
      height: 400px;
      border: 1px solid #000;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      background: url('./img/bg.jpg') repeat;
      animation: moveBg 1.5s infinite linear;
    }
    @keyframes moveBg {
      from { background-position: 0 0; }
      to { background-position: 0 130%; }
    }
    #player {
      width: 80px;
      height: 50px;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translate(-50%);
      background: url('./img/player.png') no-repeat center / contain;
    }
    .bullet {
      position: absolute;
      width: 6px;
      height: 10px;
      background: url('./img/shot.png') no-repeat center / contain;
    }
    .enemy {
      z-index: 2;
      width: 60px;
      height: 40px;
      position: absolute;
      background: url('./img/alien.png') no-repeat center / contain;
    }
    .explosion {
      width: 60px;
      height: 60px;
      position: absolute;
      background: url('./img/explosion.png') no-repeat center / contain;
    }
    .points {
      z-index: 3;
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 28px;
      font-weight: bold;
      color: rgb(38, 206, 38);
      height: 10px;
    }
    .points img {
      width: 22px;
      vertical-align: middle;
    }
    #lifes {
      z-index: 3;
      right: 20px;
      top: 20px;
      position: absolute;
      display: flex;
      gap: 10px;
    }
    .life {
      width: 25px;
      height: 25px;
      background: url('./img/life.png') no-repeat center / contain;
    }
  </style>
</head>
<body>
  <h1>Space defender</h1>

  <div id="game-board">
    <div id="player"></div>
    <div class="points">
      <img src="./img/coin.png" />
      <span id="score">0</span>
    </div>
    <div id="lifes"></div>
  </div>
  
  <script>
    const bullets = [];
    const enemies = [];
    let score = 0;
    let lifes = 3;

    // pobranie elementów
    const playerElement = document.querySelector('#player');
    const boardElement = document.querySelector('#game-board');
    const scoreElement = document.querySelector('#score');
    const lifesElemeent = document.querySelector('#lifes')

    const movePlayer = (direction) => {
      // policz nową pozycje playera
      const newPosition = playerElement.offsetLeft + direction * 10;
      // pobierz pozycję planszy
      const { left, right } = boardElement.getBoundingClientRect();
      const minLeft = playerElement.offsetWidth / 2;
      const maxRight = right - left - minLeft;

      // przesuń playera jeśli mieści się w planszy
      if (newPosition >= minLeft && newPosition < maxRight) {
        playerElement.style.left = `${newPosition}px`;
      }
    }

    const creatBullet = () => {
      // zdefiniuj pocisk
      const bullet = document.createElement('div');
      bullet.className = 'bullet';
      bullet.style.left = `${playerElement.offsetLeft}px`;
      bullet.style.bottom = `${playerElement.offsetHeight}px`;

      // dodaj na plansze
      boardElement.appendChild(bullet);
      bullets.push(bullet);
    }

    const handleKeyboard = (e) => {
      switch (e.code) {
        case 'ArrowLeft': movePlayer(-1); break;
        case 'ArrowRight': movePlayer(1); break;
        case 'Space': creatBullet();
      }
    }

    // obsłużenie klawiatury
    window.addEventListener('keydown', handleKeyboard);

    const checkCollision = (bullet, enemy) => {
      return (bullet.left > enemy.left && bullet.right < enemy.right)
        && (bullet.top < enemy.bottom);
    }

    const addScore = (points = 0) => {
      score += points;
      scoreElement.innerHTML = score;
    }

    const showLifes = () => {
      const html = Array(lifes)
        .fill(0)
        .map(n => '<div class="life"></div>')
        .join('');

      lifesElemeent.innerHTML = html;
    }

    const checkBulletCollision = (bullet) => {
      const position = bullet.getBoundingClientRect();

      for (let i = 0; i < enemies.length; i++) {
        const enemy = enemies[i];
        const enemyPostion = enemy.getBoundingClientRect();

        // czy pocisk i statek znajdują się w tym samym miejscu
        if (checkCollision(position, enemyPostion)) {
          // dodaj punkty
          addScore(1);

          // usuń pocisk
          const idx = bullets.indexOf(bullet);
          bullets.splice(idx, 1);
          bullet.remove();

          // dodaj wybuch
          makeExplosion(enemy.offsetLeft, enemy.offsetTop);

          // usuń trafiony statek
          enemies.splice(i, 1);
          enemy.remove();

          break;
        }
      }
    }

    const makeExplosion = (left, top) => {
      // zdefiniuj wybuch
      const explosion = document.createElement('div');
      explosion.className = 'explosion';
      explosion.style.left = `${left}px`;
      explosion.style.top = `${top}px`;

      // dodaj wybuch na mapie
      boardElement.appendChild(explosion);

      // usun wybuch po 2 sek
      setTimeout(() => {
        explosion.remove();
      }, 2000);
    }

    const moveBullets = () => {
      for (let i = 0; i < bullets.length; i++) {
        const bullet = bullets[i];

        // przesuń pocisk
        bullet.style.top = `${bullet.offsetTop - 10}px`;

        if (bullet.offsetTop <= 0) {
          // usuń pocisk jeśli jest za mapą
          bullets.splice(i, 1);
          i--;
          bullet.remove();
        } else {
          // sprawdź czy coś trafił
          checkBulletCollision(bullet);
        }
      }
    }

    const createEnemy = () => {
      // tworz statki losowo (raz tak, raz nie)
      const shouldCreate = Math.round(Math.random());
      if (!shouldCreate) return;

      // zdefiniuj statek
      const enemy = document.createElement('div');
      enemy.className = 'enemy';
      enemy.style.top = -40 + 'px';
      enemy.style.left = `${Math.floor(Math.random() * (boardElement.offsetWidth - 120) + 60)}px`;

      // dodaj do mapy
      boardElement.append(enemy);
      enemies.push(enemy);
    }

    const moveEnemies = () => {
      for (let i = 0; i < enemies.length; i++) {
        const enemy = enemies[i];
        // przesuń statek w dół
        enemy.style.top = `${enemy.offsetTop + 5}px`;

        // gdy statek wyjedzie poza mapę
        if (enemy.offsetTop >= boardElement.offsetHeight) {
          // odejmij punkt życia
          lifes--;
          showLifes();

          // usun wroga z mapy
          enemies.splice(i, 1);
          enemy.remove();

          // koniec gry
          if (lifes === 0) {
            alert('Koniec gry!');
          }
        }
      }
    }

    // intervały
    setInterval(moveBullets, 50);
    setInterval(moveEnemies, 200);
    setInterval(createEnemy, 1000);

    showLifes();
  </script>
  
</body>
</html>